{% extends "base.html" %}

{% block title %}{{ exercise.title }} - Pythonå­¦ä¹ ç½‘{% endblock %}

{% block content %}
<div class="container">
    <nav class="breadcrumb">
        <a href="{{ url_for('exercises') }}">ç»ƒä¹ </a> / {{ exercise.title }}
    </nav>
    
    <article class="exercise-content">
        <header class="exercise-header">
            <h1>{{ exercise.title }}</h1>
            <p class="exercise-description">{{ exercise.description }}</p>
        </header>
        
        <div class="questions-list">
            {% for question in exercise.questions %}
            <div class="question-card" id="question-{{ question.id }}">
                <div class="question-header">
                    <h3>é—®é¢˜ {{ question.id }}:</h3>
                    <span class="question-status" id="status-{{ question.id }}">æœªå®Œæˆ</span>
                </div>
                <div class="question-body">
                    <div class="problem-statement">
                        <p>{{ question.question }}</p>
                    </div>
                    
                    <!-- ä»£ç ç¼–è¾‘å™¨åŒºåŸŸ -->
                    <div class="code-editor-section">
                        <h4>ç¼–å†™ä½ çš„è§£å†³æ–¹æ¡ˆï¼š</h4>
                        <div class="editor-wrapper">
                            <div class="editor-toolbar">
                                <button class="btn btn-small run-btn" data-question="{{ question.id }}">
                                    <i class="fas fa-play"></i> è¿è¡Œä»£ç 
                                </button>
                                <button class="btn btn-small reset-btn" data-question="{{ question.id }}">
                                    <i class="fas fa-redo"></i> é‡ç½®ä»£ç 
                                </button>
                                <button class="btn btn-small show-hint" data-question="{{ question.id }}">
                                    <i class="fas fa-lightbulb"></i> æ˜¾ç¤ºæç¤º
                                </button>
                                <button class="btn btn-small show-solution" data-question="{{ question.id }}">
                                    <i class="fas fa-code"></i> æŸ¥çœ‹ç­”æ¡ˆ
                                </button>
                            </div>
                            
                            <textarea id="editor-{{ question.id }}" class="code-editor" 
                                      placeholder="åœ¨è¿™é‡Œç¼–å†™ä½ çš„Pythonä»£ç ..."
                                      rows="10"># è¯·åœ¨è¿™é‡Œç¼–å†™ä½ çš„ä»£ç 
# ä¾‹å¦‚ï¼š
print("å¼€å§‹è§£å†³é—®é¢˜")</textarea>
                            
                            <div class="editor-output" id="output-{{ question.id }}">
                                <div class="output-header">è¿è¡Œç»“æœ</div>
                                <div class="output-content">
                                    <!-- è¿è¡Œç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æç¤ºåŒºåŸŸï¼ˆé»˜è®¤éšè—ï¼‰ -->
                    <div class="hint-section" id="hint-{{ question.id }}" style="display: none;">
                        <div class="hint-header">
                            <strong><i class="fas fa-lightbulb"></i> æç¤ºï¼š</strong>
                        </div>
                        <div class="hint-content">
                            {{ question.hint }}
                        </div>
                    </div>
                    
                    <!-- å‚è€ƒç­”æ¡ˆåŒºåŸŸï¼ˆé»˜è®¤éšè—ï¼‰ -->
                    <div class="solution-section" id="solution-{{ question.id }}" style="display: none;">
                        <div class="solution-header">
                            <strong><i class="fas fa-code"></i> å‚è€ƒç­”æ¡ˆï¼š</strong>
                            <button class="btn btn-small copy-solution" data-code="{{ question.solution }}">
                                <i class="fas fa-copy"></i> å¤åˆ¶ä»£ç 
                            </button>
                        </div>
                        <div class="solution-content">
                            <pre><code>{{ question.solution }}</code></pre>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="exercise-navigation">
            <a href="{{ url_for('exercises') }}" class="btn">
                <i class="fas fa-arrow-left"></i> è¿”å›ç»ƒä¹ åˆ—è¡¨
            </a>
            <button class="btn btn-primary" id="submit-all">
                <i class="fas fa-paper-plane"></i> æäº¤æ‰€æœ‰ç­”æ¡ˆ
            </button>
        </div>
    </article>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ä¸ºæ¯ä¸ªé—®é¢˜åˆå§‹åŒ–ä»£ç ç¼–è¾‘å™¨
    {% for question in exercise.questions %}
    (function() {
        const questionId = {{ question.id }};
        const editor = document.getElementById(`editor-${questionId}`);
        const output = document.querySelector(`#output-${questionId} .output-content`);
        const status = document.getElementById(`status-${questionId}`);
        const solution = `{{ question.solution|safe }}`;
        
        // è®¾ç½®åˆå§‹ä»£ç ï¼ˆå¸¦ç¤ºä¾‹ï¼‰
        const initialCode = `# é—®é¢˜ {{ question.id }}: {{ question.question|truncate(50) }}

# è¯·åœ¨è¿™é‡Œç¼–å†™ä½ çš„è§£å†³æ–¹æ¡ˆ
# ç¤ºä¾‹ä»£ç ï¼š
print("å¼€å§‹è§£å†³é—®é¢˜ {{ question.id }}")

`;
        if (!editor.value.trim()) {
            editor.value = initialCode;
        }
        
        // è¿è¡Œä»£ç æŒ‰é’®
        document.querySelector(`.run-btn[data-question="${questionId}"]`).addEventListener('click', function() {
            runCode(questionId, editor.value);
        });
        
        // é‡ç½®ä»£ç æŒ‰é’®
        document.querySelector(`.reset-btn[data-question="${questionId}"]`).addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦é‡ç½®ä»£ç å—ï¼Ÿæ‰€æœ‰ä¿®æ”¹å°†ä¼šä¸¢å¤±ã€‚')) {
                editor.value = initialCode;
                output.innerHTML = '';
                status.textContent = 'æœªå®Œæˆ';
                status.className = 'question-status';
            }
        });
        
        // è¿è¡Œä»£ç å‡½æ•°
        function runCode(qId, code) {
            output.innerHTML = '<div class="loading">æ­£åœ¨è¿è¡Œä»£ç ...</div>';
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šå‘é€åˆ°åç«¯æ‰§è¡Œ
            // ç”±äºå®‰å…¨è€ƒè™‘ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿæ‰§è¡Œ
            setTimeout(() => {
                // ç®€å•æ£€æŸ¥ä»£ç æ˜¯å¦åŒ…å«å¿…è¦å…ƒç´ 
                let result = '';
                let success = true;
                
                if (code.includes('print')) {
                    result = 'ä»£ç è¿è¡ŒæˆåŠŸï¼\n';
                    result += 'è¾“å‡ºç¤ºä¾‹ï¼š\n';
                    result += 'å¼€å§‹è§£å†³é—®é¢˜\n';
                    result += 'è§£å†³æ–¹æ¡ˆæ‰§è¡Œä¸­...\n';
                    result += 'âœ“ æµ‹è¯•é€šè¿‡\n';
                    
                    // æ›´æ–°çŠ¶æ€
                    status.textContent = 'å·²å®Œæˆ';
                    status.className = 'question-status completed';
                } else {
                    result = 'è¯·ç¡®ä¿ä»£ç ä¸­åŒ…å«è¾“å‡ºè¯­å¥ï¼ˆprintï¼‰æ¥æŸ¥çœ‹ç»“æœã€‚';
                    success = false;
                }
                
                if (success) {
                    output.innerHTML = `<pre class="success">${result}</pre>`;
                } else {
                    output.innerHTML = `<pre class="error">${result}</pre>`;
                }
            }, 1000);
        }
    })();
    {% endfor %}
    
    // æ˜¾ç¤ºæç¤º
    document.querySelectorAll('.show-hint').forEach(button => {
        button.addEventListener('click', function() {
            const questionId = this.dataset.question;
            const hintSection = document.getElementById(`hint-${questionId}`);
            hintSection.style.display = 'block';
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-lightbulb"></i> æç¤ºå·²æ˜¾ç¤º';
        });
    });
    
    // æ˜¾ç¤ºç­”æ¡ˆ
    document.querySelectorAll('.show-solution').forEach(button => {
        button.addEventListener('click', function() {
            const questionId = this.dataset.question;
            const solutionSection = document.getElementById(`solution-${questionId}`);
            solutionSection.style.display = 'block';
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-code"></i> ç­”æ¡ˆå·²æ˜¾ç¤º';
        });
    });
    
    // å¤åˆ¶ç­”æ¡ˆä»£ç 
    document.querySelectorAll('.copy-solution').forEach(button => {
        button.addEventListener('click', function() {
            const code = this.dataset.code;
            navigator.clipboard.writeText(code)
                .then(() => {
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-check"></i> å·²å¤åˆ¶';
                    setTimeout(() => {
                        this.innerHTML = originalText;
                    }, 2000);
                });
        });
    });
    
    // æäº¤æ‰€æœ‰ç­”æ¡ˆ
    document.getElementById('submit-all').addEventListener('click', function() {
        let completed = 0;
        const total = {{ exercise.questions|length }};
        
        // æ£€æŸ¥æ¯ä¸ªé—®é¢˜çš„çŠ¶æ€
        for (let i = 1; i <= total; i++) {
            const status = document.getElementById(`status-${i}`);
            if (status && status.textContent === 'å·²å®Œæˆ') {
                completed++;
            }
        }
        
        if (completed === total) {
            alert(`ğŸ‰ æ­å–œï¼ä½ å·²å®Œæˆæ‰€æœ‰ ${total} ä¸ªé—®é¢˜ï¼`);
        } else {
            alert(`ä½ å·²å®Œæˆ ${completed}/${total} ä¸ªé—®é¢˜ã€‚ç»§ç»­åŠ æ²¹ï¼`);
        }
    });
});
</script>
{% endblock %}